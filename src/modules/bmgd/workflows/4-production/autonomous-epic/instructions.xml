<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language}</critical>
  <critical>ğŸ¤– AUTONOMOUS EPIC PROCESSING - Full automation of epic completion!</critical>
  <critical>This workflow orchestrates create-story and super-dev-story for each story in an epic</critical>

  <step n="1" goal="Initialize and validate epic">
    <output>ğŸ¤– **Autonomous Epic Processing**

      This workflow will automatically:
      1. Create each story just-in-time (using create-story)
      2. Develop each story (using super-dev-story or dev-story)
      3. Commit and push after each story (integrated in super-dev)
      4. Generate epic completion report

      **Time Estimate:** Varies by epic size
      - Small epic (3-5 stories): 3-6 hours
      - Medium epic (6-10 stories): 6-12 hours
      - Large epic (11+ stories): 12-24 hours

      **Token Usage:** ~100K-150K per story
    </output>

    <check if="{{epic_num}} provided">
      <action>Use provided epic number</action>
      <goto anchor="validate_epic" />
    </check>

    <ask>Enter epic number to process (e.g., "2" or "epic-3"), or [q] to quit:</ask>

    <check if="user provides epic number">
      <action>Parse epic number from input</action>
      <goto anchor="validate_epic" />
    </check>

    <check if="user says q">
      <output>ğŸ‘‹ Autonomous epic processing cancelled.</output>
      <action>HALT</action>
    </check>

    <anchor id="validate_epic" />

    <action>Load {{sprint_status}} file</action>
    <action>Find epic-{{epic_num}} entry</action>
    <action>Count stories by status (backlog, ready-for-dev, in-progress, review, done)</action>

    <output>
      ğŸ“Š **Epic {{epic_num}} Status**

      Total stories: {{total_story_count}}
      - Backlog: {{backlog_count}} (will create + develop)
      - Ready-for-dev: {{ready_count}} (will develop)
      - In-progress: {{inprogress_count}} (will resume)
      - Review/Done: {{done_count}} (will skip)

      **Work Remaining:** {{work_count}} stories
      **Estimated Time:** {{estimated_hours}} hours
      **Estimated Tokens:** ~{{estimated_tokens}}K
    </output>

    <ask>**Proceed with autonomous processing?**

      [Y] Yes - Use super-dev-story (comprehensive validation)
      [D] Dev-story - Faster, less validation
      [n] No - Cancel
    </ask>

    <check if="user says Y">
      <action>Set {{dev_workflow}} = "super-dev-story"</action>
    </check>

    <check if="user says D">
      <action>Set {{dev_workflow}} = "dev-story"</action>
    </check>

    <check if="user says n">
      <output>âŒ Cancelled</output>
      <action>HALT</action>
    </check>
  </step>

  <step n="2" goal="Create git branch and initialize tracking">
    <action>Get current branch name</action>
    <action>Create new branch: auto-epic-{{epic_num}}</action>
    <output>ğŸ“ Created branch: auto-epic-{{epic_num}}</output>

    <action>Initialize progress tracking file:
      - epic_num
      - started timestamp
      - total_stories
      - completed_stories: []
      - current_story: null
      - status: running
    </action>
  </step>

  <step n="3" goal="Process all stories in epic">
    <critical>ğŸ”„ STORY LOOP - Create and develop each story</critical>

    <action>Find all stories in epic {{epic_num}} needing work</action>
    <action>Sort by story number (ascending)</action>
    <action>Initialize counters: success=0, failure=0</action>

    <!-- STORY LOOP -->
    <loop foreach="{{stories_needing_work}}">
      <action>Set {{current_story}}</action>

      <output>
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Story {{counter}}/{{work_count}}: {{current_story.key}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      </output>

      <!-- CREATE STORY IF NEEDED -->
      <check if="status == 'backlog'">
        <output>ğŸ“ Creating story...</output>

        <try>
          <invoke-workflow path="{project-root}/_bmad/bmgd/workflows/4-production/create-story/workflow.yaml">
            <note>Create story just-in-time</note>
          </invoke-workflow>

          <output>âœ… Story created</output>
        </try>

        <catch>
          <output>âŒ Failed to create story: {{error}}</output>
          <action>Add to failed_stories, continue to next</action>
          <continue />
        </catch>
      </check>

      <!-- DEVELOP STORY -->
      <output>ğŸ’» Developing with {{dev_workflow}}...</output>

      <try>
        <check if="{{dev_workflow}} == 'super-dev-story'">
          <invoke-workflow path="{project-root}/_bmad/bmgd/workflows/4-production/super-dev-story/workflow.yaml">
            <input name="story_file" value="{{current_story_file}}" />
            <note>Includes: dev + post-gap + review + push-all</note>
          </invoke-workflow>
        </check>

        <check if="{{dev_workflow}} == 'dev-story'">
          <invoke-workflow path="{project-root}/_bmad/bmgd/workflows/4-production/dev-story/workflow.yaml">
            <input name="story_file" value="{{current_story_file}}" />
          </invoke-workflow>

          <!-- Push after dev-story -->
          <invoke-workflow path="{project-root}/_bmad/bmgd/workflows/4-production/push-all/workflow.yaml">
            <note>Commit and push story changes</note>
          </invoke-workflow>
        </check>

        <output>âœ… Story complete and pushed</output>
        <action>Increment success_count</action>
        <action>Update progress file</action>
      </try>

      <catch>
        <output>âŒ Story failed: {{error}}</output>
        <action>Add to failed_stories, continue</action>
        <action>Increment failure_count</action>
      </catch>

      <output>Progress: {{success_count}} âœ… | {{failure_count}} âŒ | {{remaining}} pending</output>
    </loop>

    <action>Update progress file status: complete</action>
  </step>

  <step n="4" goal="Epic completion and reporting">
    <output>
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ‰ EPIC {{epic_num}} COMPLETE!
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      **Results:**
      âœ… Stories completed: {{success_count}}/{{total_count}}
      {{if_failures}}âŒ Stories failed: {{failure_count}}{{endif}}

      **Branch:** auto-epic-{{epic_num}}
      **All changes pushed to remote**

      {{if_all_success}}
      **Epic {{epic_num}} marked complete in sprint-status.yaml**
      {{endif}}

      **Next Steps:**
      1. Review the work on branch auto-epic-{{epic_num}}
      2. Run human code review
      3. Merge when approved

      {{if_failures}}
      **Failed Stories Need Attention:**
      {{list_failed_stories}}
      {{endif}}
    </output>

    <check if="{{success_count}} == {{total_count}}">
      <action>Update sprint-status: epic-{{epic_num}} = "done"</action>
    </check>

    <action>Remove progress file</action>
  </step>

</workflow>
