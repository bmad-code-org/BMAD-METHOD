<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language}</critical>
  <critical>ğŸ¤– AUTONOMOUS EPIC PROCESSING - Full automation of epic completion!</critical>
  <critical>This workflow orchestrates create-story and super-dev-story for each story in an epic</critical>
  <critical>TASK-BASED COMPLETION: A story is ONLY complete when it has ZERO unchecked tasks (- [ ])</critical>

  <!-- AUTONOMOUS MODE INSTRUCTIONS - READ THESE CAREFULLY -->
  <critical>âš¡ AUTONOMOUS MODE: When auto_accept_gap_analysis=true in workflow.yaml, you MUST:
    - NEVER ask the user to approve gap analysis refinements
    - AUTOMATICALLY accept all gap analysis proposals
    - PROCEED immediately without waiting for user input on gap analysis
    - Only ask for user input at the START of the workflow (epic selection, Y/D/n choice)
  </critical>
  <critical>âš¡ INVOKING SUB-WORKFLOWS: When you see invoke-workflow, you must:
    1. Load the referenced workflow.yaml file
    2. Load its instructions.xml file
    3. Execute that workflow completely
    4. Return to this workflow and continue
  </critical>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- ğŸš¨ CRITICAL: YOLO MODE CLARIFICATION ğŸš¨                                         -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <critical>ğŸš¨ WHAT YOLO MODE MEANS:
    - YOLO mode ONLY means: automatically answer "y", "Y", "C", or "continue" to prompts
    - YOLO mode does NOT mean: skip steps, skip workflows, skip verification, or produce minimal output
    - YOLO mode does NOT mean: pretend work was done when it wasn't
    - ALL steps must still be fully executed - just without waiting for user confirmation
    - ALL invoke-workflow calls must still be fully executed
    - ALL verification checks must still pass
  </critical>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- ğŸš¨ ANTI-SKIP SAFEGUARDS - THESE ARE NON-NEGOTIABLE ğŸš¨                           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <critical>ğŸš¨ STORY CREATION IS SACRED - YOU MUST ACTUALLY RUN CREATE-STORY:
    - DO NOT just output "Creating story..." and move on
    - DO NOT skip the invoke-workflow tag
    - DO NOT pretend the story was created
    - You MUST fully execute the create-story workflow with ALL its steps
    - The story file MUST exist and be verified BEFORE proceeding
  </critical>
  <critical>ğŸš¨ CREATE-STORY QUALITY REQUIREMENTS:
    - create-story must analyze epics, PRD, architecture, and UX documents
    - create-story must produce comprehensive story files (4kb+ minimum)
    - Tiny story files (under 4kb) indicate the workflow was not properly executed
    - Story files MUST contain: Tasks/Subtasks, Acceptance Criteria, Dev Notes, Architecture Constraints
  </critical>
  <critical>ğŸš¨ HARD VERIFICATION REQUIRED AFTER STORY CREATION:
    - After invoke-workflow for create-story completes, you MUST verify:
      1. The story file EXISTS on disk (use file read/check)
      2. The story file is AT LEAST 4000 bytes (use wc -c or file size check)
      3. The story file contains required sections (Tasks, Acceptance Criteria, Dev Notes)
    - If ANY verification fails: HALT and report error - do NOT proceed to super-dev-pipeline
    - Do NOT trust "Story created" output without verification
  </critical>

  <step n="1" goal="Initialize and validate epic">
    <output>ğŸ¤– **Autonomous Epic Processing**

      This workflow will automatically:
      1. Create stories (if backlog) using create-story
      2. Develop each story using super-dev-pipeline
      3. **Verify completion** by checking ALL tasks are done (- [x])
      4. Commit and push after each story (integrated in super-dev-pipeline)
      5. Generate epic completion report

      **super-dev-pipeline includes:**
      - Pre-gap analysis (validates existing code - critical for brownfield!)
      - Adaptive implementation (TDD for new, refactor for existing)
      - **Post-implementation validation** (catches false positives!)
      - Code review (adversarial, finds 3-10 issues)
      - Completion (commit + push)

      **Key Features:**
      - âœ… Works for greenfield AND brownfield development
      - âœ… Step-file architecture prevents vibe coding
      - âœ… Disciplined execution even at high token counts
      - âœ… All quality gates enforced

      ğŸš¨ **QUALITY SAFEGUARDS (Non-Negotiable):**
      - Story files MUST be created via full create-story execution
      - Story files MUST be at least 4kb (comprehensive, not YOLO'd)
      - Story files MUST contain: Tasks, Acceptance Criteria, Dev Notes
      - YOLO mode = auto-approve prompts, NOT skip steps or produce minimal output
      - Verification happens AFTER each story creation - failures halt processing

      **Key Improvement:** Stories in "review" status with unchecked tasks
      WILL be processed - we check actual task completion, not just status!

      **Time Estimate:** Varies by epic size
      - Small epic (3-5 stories): 2-5 hours
      - Medium epic (6-10 stories): 5-10 hours
      - Large epic (11+ stories): 10-20 hours

      **Token Usage:** ~40-60K per story (more efficient + brownfield support!)
    </output>

    <check if="{{epic_num}} provided">
      <action>Use provided epic number</action>
      <goto anchor="validate_epic" />
    </check>

    <ask>Enter epic number to process (e.g., "2" or "epic-3"), or [q] to quit:</ask>

    <check if="user provides epic number">
      <action>Parse epic number from input</action>
      <goto anchor="validate_epic" />
    </check>

    <check if="user says q">
      <output>ğŸ‘‹ Autonomous epic processing cancelled.</output>
      <action>HALT</action>
    </check>

    <anchor id="validate_epic" />

    <action>Load {{sprint_status}} file</action>
    <action>Find epic-{{epic_num}} entry and all story entries for this epic</action>

    <!-- TASK-BASED ANALYSIS: Scan actual story files for unchecked tasks -->
    <action>For each story in epic:
      1. Read the story file from {{story_dir}}/{{story_key}}.md
      2. Count unchecked tasks: grep -c "^- \[ \]" or regex match "- \[ \]"
      3. Count checked tasks: grep -c "^- \[x\]" or regex match "- \[x\]"
      4. Categorize story:
         - "truly_done": status=done AND unchecked_tasks=0
         - "needs_work": unchecked_tasks > 0 (regardless of status)
         - "backlog": status=backlog (file may not exist yet)
    </action>

    <output>
      ğŸ“Š **Epic {{epic_num}} Status (Task-Based Analysis)**

      Total stories: {{total_story_count}}

      **By Actual Task Completion:**
      - âœ… Truly Done: {{truly_done_count}} (all tasks checked, will skip)
      - ğŸ”§ Needs Work: {{needs_work_count}} (has unchecked tasks)
        {{list_needs_work_with_task_counts}}
      - ğŸ“ Backlog: {{backlog_count}} (will create + develop)

      **By Status (for reference):**
      - done: {{done_status_count}}
      - review: {{review_status_count}}
      - in-progress: {{inprogress_status_count}}
      - ready-for-dev: {{ready_status_count}}
      - backlog: {{backlog_status_count}}

      **Work Remaining:** {{work_count}} stories with {{total_unchecked_tasks}} unchecked tasks
      **Estimated Time:** {{estimated_hours}} hours
      **Estimated Tokens:** ~{{estimated_tokens}}K
    </output>

    <ask>**Proceed with autonomous processing?**

      [Y] Yes - Use super-dev-pipeline (works for greenfield AND brownfield)
      [n] No - Cancel

      Note: super-dev-pipeline uses step-file architecture to prevent vibe coding!
    </ask>

    <check if="user says Y">
      <action>Set {{use_super_dev_pipeline}} = true</action>
    </check>

    <check if="user says n">
      <output>âŒ Cancelled</output>
      <action>HALT</action>
    </check>
  </step>

  <step n="2" goal="Initialize tracking (optionally create branch)">
    <action>Get current branch name and store as {{current_branch}}</action>

    <check if="{{create_epic_branch}} == true">
      <action>Create new branch: auto-epic-{{epic_num}}</action>
      <output>ğŸ“ Created branch: auto-epic-{{epic_num}}</output>
    </check>

    <check if="{{create_epic_branch}} == false">
      <output>ğŸ“ Staying on current branch: {{current_branch}} (parallel epic mode)</output>
    </check>

    <action>Initialize progress tracking file:
      - epic_num
      - started timestamp
      - total_stories
      - completed_stories: []
      - current_story: null
      - status: running
    </action>

    <!-- Keep sprint-status accurate at start -->
    <action>Update sprint-status: if epic-{{epic_num}} is "backlog" or "contexted", set to "in-progress"</action>
  </step>

  <step n="3" goal="Process all stories in epic">
    <critical>ğŸ”„ STORY LOOP - Create and develop each story until ALL tasks complete</critical>

    <action>Build ordered list of stories needing work:
      1. All stories with unchecked tasks (regardless of status)
      2. All backlog stories
      3. Sort by story number (ascending)
    </action>
    <action>Initialize counters: success=0, failure=0</action>

    <!-- STORY LOOP -->
    <loop foreach="{{stories_needing_work}}">
      <action>Set {{current_story}}</action>
      <action>Read story file and count unchecked tasks</action>

      <output>
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Story {{counter}}/{{work_count}}: {{current_story.key}}
        Status: {{current_story.status}} | Unchecked Tasks: {{unchecked_count}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      </output>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- CREATE STORY IF BACKLOG - WITH MANDATORY VERIFICATION                   -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <check if="status == 'backlog'">
        <output>ğŸ“ Creating story from epic - THIS REQUIRES FULL WORKFLOW EXECUTION...</output>
        <output>âš ï¸ REMINDER: You MUST fully execute create-story, not just output messages!</output>

        <try>
          <!-- STEP 1: Actually invoke and execute create-story workflow -->
          <invoke-workflow path="{project-root}/_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml">
            <input name="story_id" value="{{current_story.key}}" />
            <note>Create story just-in-time - MUST FULLY EXECUTE ALL STEPS</note>
            <note>This workflow must load epics, PRD, architecture, UX docs</note>
            <note>This workflow must produce a comprehensive 4kb+ story file</note>
          </invoke-workflow>

          <!-- STEP 2: HARD VERIFICATION - Story file must exist -->
          <action>Set {{expected_story_file}} = {{story_dir}}/story-{{epic_num}}.{{story_num}}.md</action>
          <action>Check if file exists: {{expected_story_file}}</action>
          <check if="story file does NOT exist">
            <output>ğŸš¨ CRITICAL ERROR: Story file was NOT created!</output>
            <output>Expected file: {{expected_story_file}}</output>
            <output>The create-story workflow did not execute properly.</output>
            <output>This story CANNOT proceed without a proper story file.</output>
            <action>Add to failed_stories with reason: "Story file not created"</action>
            <continue />
          </check>

          <!-- STEP 3: HARD VERIFICATION - Story file must be at least 4kb -->
          <action>Get file size of {{expected_story_file}} in bytes</action>
          <check if="file size < 4000 bytes">
            <output>ğŸš¨ CRITICAL ERROR: Story file is too small ({{file_size}} bytes)!</output>
            <output>Minimum required: 4000 bytes</output>
            <output>This indicates create-story was skipped or improperly executed.</output>
            <output>A proper story file should contain:</output>
            <output>  - Detailed acceptance criteria</output>
            <output>  - Comprehensive tasks/subtasks</output>
            <output>  - Dev notes with architecture constraints</output>
            <output>  - Source references</output>
            <output>This story CANNOT proceed with an incomplete story file.</output>
            <action>Add to failed_stories with reason: "Story file too small - workflow not properly executed"</action>
            <continue />
          </check>

          <!-- STEP 4: HARD VERIFICATION - Story file must have required sections -->
          <action>Read {{expected_story_file}} and check for required sections</action>
          <check if="file missing '## Tasks' OR '## Acceptance Criteria'">
            <output>ğŸš¨ CRITICAL ERROR: Story file missing required sections!</output>
            <output>Required sections: Tasks, Acceptance Criteria</output>
            <output>This story CANNOT proceed without proper structure.</output>
            <action>Add to failed_stories with reason: "Story file missing required sections"</action>
            <continue />
          </check>

          <output>âœ… Story created and verified:</output>
          <output>   - File exists: {{expected_story_file}}</output>
          <output>   - File size: {{file_size}} bytes (meets 4kb minimum)</output>
          <output>   - Required sections: present</output>
          <action>Update sprint-status: set {{current_story.key}} to "ready-for-dev" (if not already)</action>
        </try>

        <catch>
          <output>âŒ Failed to create story: {{error}}</output>
          <action>Add to failed_stories with error details</action>
          <continue />
        </catch>
      </check>

      <!-- DEVELOP STORY WITH SUPER-DEV-PIPELINE (handles both greenfield AND brownfield) -->
      <check if="{{unchecked_count}} > 0">
        <action>Update sprint-status: set {{current_story.key}} to "in-progress"</action>
        <output>ğŸ’» Developing story with super-dev-pipeline ({{unchecked_count}} tasks remaining)...</output>

        <try>
          <invoke-workflow path="{project-root}/_bmad/bmm/workflows/4-implementation/super-dev-pipeline/workflow.yaml">
            <input name="story_id" value="{{current_story.key}}" />
            <input name="story_file" value="{{current_story_file}}" />
            <input name="mode" value="batch" />
            <note>Step-file execution: pre-gap â†’ implement â†’ post-validate â†’ review â†’ commit</note>
          </invoke-workflow>

          <!-- super-dev-pipeline handles verification internally, just check final status -->
          <output>âœ… super-dev-pipeline completed</output>

          <!-- VERIFY COMPLETION: Re-check for unchecked tasks -->
          <action>Re-read story file and count unchecked tasks</action>

          <check if="{{remaining_unchecked}} > 0">
            <output>âš ï¸ Story still has {{remaining_unchecked}} unchecked tasks after super-dev-pipeline</output>
            <action>Log incomplete tasks for review</action>
            <action>Mark as partial success</action>
            <action>Update sprint-status: set {{current_story.key}} to "review"</action>
          </check>

          <check if="{{remaining_unchecked}} == 0">
            <output>âœ… Story complete - all tasks checked!</output>
            <action>Update story status to "done" in sprint-status.yaml</action>
          </check>

          <action>Increment success_count</action>
          <action>Update progress file</action>
        </try>

        <catch>
          <output>âŒ super-dev-pipeline failed: {{error}}</output>
          <action>Add to failed_stories with error details</action>
          <action>Increment failure_count</action>
        </catch>
      </check>

      <output>Progress: {{success_count}} âœ… | {{failure_count}} âŒ | {{remaining}} pending</output>
    </loop>

    <action>Update progress file status: complete</action>
  </step>

  <step n="4" goal="Epic completion and reporting">
    <!-- Final verification: scan all stories for unchecked tasks -->
    <action>Re-scan all epic stories for unchecked tasks</action>
    <action>Calculate: total_remaining_tasks across all stories</action>

    <output>
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ‰ EPIC {{epic_num}} PROCESSING COMPLETE!
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      **Results:**
      âœ… Stories processed: {{success_count}}/{{total_count}}
      {{if_failures}}âŒ Stories failed: {{failure_count}}{{endif}}

      **Task Completion:**
      - Total tasks in epic: {{total_tasks}}
      - Completed: {{completed_tasks}} âœ…
      - Remaining: {{remaining_tasks}} â³

      **Branch:** {{current_branch}}
      **All changes committed**

      {{if_all_tasks_complete}}
      âœ… **All tasks complete! Epic {{epic_num}} marked done in sprint-status.yaml**
      {{endif}}

      {{if_tasks_remaining}}
      âš ï¸ **{{remaining_tasks}} tasks still unchecked - epic NOT marked complete**
      Stories with remaining work:
      {{list_incomplete_stories}}
      {{endif}}

      **Next Steps:**
      1. Review the work on branch {{current_branch}}
      2. Run human code review
      3. Merge when approved

      {{if_failures}}
      **Failed Stories Need Attention:**
      {{list_failed_stories}}
      {{endif}}
    </output>

    <check if="{{remaining_tasks}} == 0 AND {{failure_count}} == 0">
      <action>Update sprint-status: epic-{{epic_num}} = "done"</action>
    </check>

    <action>Remove progress file</action>
  </step>

</workflow>
