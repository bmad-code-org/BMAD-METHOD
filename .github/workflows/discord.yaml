name: Discord Notification

on:
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  release:
    types: [published]
  create:
  delete:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, closed, reopened]

env:
  MAX_TITLE: 100
  MAX_BODY: 250

jobs:
  pull_request:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ACTION: ${{ github.event.action }}
          MERGED: ${{ github.event.pull_request.merged }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_USER: ${{ github.event.pull_request.user.login }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          if [ "$ACTION" = "opened" ]; then ICON="üîÄ"; LABEL="New PR"
          elif [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then ICON="üéâ"; LABEL="Merged"
          elif [ "$ACTION" = "closed" ]; then ICON="‚ùå"; LABEL="Closed"
          elif [ "$ACTION" = "reopened" ]; then ICON="üîÑ"; LABEL="Reopened"
          else ICON="üìã"; LABEL="Ready"; fi

          TITLE=$(echo "$PR_TITLE" | trunc $MAX_TITLE | esc)
          [ ${#PR_TITLE} -gt ${#TITLE} ] && TITLE="${TITLE}..."
          BODY=$(echo "$PR_BODY" | trunc $MAX_BODY | esc)
          [ -n "$PR_BODY" ] && [ ${#PR_BODY} -gt ${#BODY} ] && BODY="${BODY}..."
          [ -n "$BODY" ] && BODY=" ¬∑ $BODY"

          MSG="$ICON **[$LABEL #$PR_NUM: $TITLE](<$PR_URL>)**"$'\n'"by @$PR_USER$BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  issues:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ACTION: ${{ github.event.action }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_USER: ${{ github.event.issue.user.login }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          if [ "$ACTION" = "opened" ]; then ICON="üêõ"; LABEL="New Issue"
          elif [ "$ACTION" = "closed" ]; then ICON="‚úÖ"; LABEL="Closed"
          else ICON="üîÑ"; LABEL="Reopened"; fi

          TITLE=$(echo "$ISSUE_TITLE" | trunc $MAX_TITLE | esc)
          [ ${#ISSUE_TITLE} -gt ${#TITLE} ] && TITLE="${TITLE}..."
          BODY=$(echo "$ISSUE_BODY" | trunc $MAX_BODY | esc)
          [ -n "$ISSUE_BODY" ] && [ ${#ISSUE_BODY} -gt ${#BODY} ] && BODY="${BODY}..."
          [ -n "$BODY" ] && BODY=" ¬∑ $BODY"

          MSG="$ICON **[$LABEL #$ISSUE_NUM: $TITLE](<$ISSUE_URL>)**"$'\n'"by @$ISSUE_USER$BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  issue_comment:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          IS_PR: ${{ github.event.issue.pull_request && 'true' || 'false' }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          [ "$IS_PR" = "true" ] && TYPE="PR" || TYPE="Issue"

          TITLE=$(echo "$ISSUE_TITLE" | trunc $MAX_TITLE | esc)
          [ ${#ISSUE_TITLE} -gt ${#TITLE} ] && TITLE="${TITLE}..."
          BODY=$(echo "$COMMENT_BODY" | trunc $MAX_BODY | esc)
          [ ${#COMMENT_BODY} -gt ${#BODY} ] && BODY="${BODY}..."

          MSG="üí¨ **[Comment on $TYPE #$ISSUE_NUM: $TITLE](<$COMMENT_URL>)**"$'\n'"@$COMMENT_USER: $BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  pull_request_review:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATE: ${{ github.event.review.state }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          REVIEW_URL: ${{ github.event.review.html_url }}
          REVIEW_USER: ${{ github.event.review.user.login }}
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          if [ "$STATE" = "approved" ]; then ICON="‚úÖ"; LABEL="Approved"
          elif [ "$STATE" = "changes_requested" ]; then ICON="üîß"; LABEL="Changes Requested"
          else ICON="üëÄ"; LABEL="Reviewed"; fi

          TITLE=$(echo "$PR_TITLE" | trunc $MAX_TITLE | esc)
          [ ${#PR_TITLE} -gt ${#TITLE} ] && TITLE="${TITLE}..."
          BODY=$(echo "$REVIEW_BODY" | trunc $MAX_BODY | esc)
          [ -n "$REVIEW_BODY" ] && [ ${#REVIEW_BODY} -gt ${#BODY} ] && BODY="${BODY}..."
          [ -n "$BODY" ] && BODY=": $BODY"

          MSG="$ICON **[$LABEL PR #$PR_NUM: $TITLE](<$REVIEW_URL>)**"$'\n'"@$REVIEW_USER$BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  pull_request_review_comment:
    if: github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          TITLE=$(echo "$PR_TITLE" | trunc $MAX_TITLE | esc)
          [ ${#PR_TITLE} -gt ${#TITLE} ] && TITLE="${TITLE}..."
          BODY=$(echo "$COMMENT_BODY" | trunc $MAX_BODY | esc)
          [ ${#COMMENT_BODY} -gt ${#BODY} ] && BODY="${BODY}..."

          MSG="üí≠ **[Review Comment PR #$PR_NUM: $TITLE](<$COMMENT_URL>)**"$'\n'"@$COMMENT_USER: $BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TAG: ${{ github.event.release.tag_name }}
          NAME: ${{ github.event.release.name }}
          URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          source .github/scripts/discord-helpers.sh

          REL_NAME=$(echo "$NAME" | trunc $MAX_TITLE | esc)
          [ ${#NAME} -gt ${#REL_NAME} ] && REL_NAME="${REL_NAME}..."
          BODY=$(echo "$RELEASE_BODY" | trunc $MAX_BODY | esc)
          [ -n "$RELEASE_BODY" ] && [ ${#RELEASE_BODY} -gt ${#BODY} ] && BODY="${BODY}..."
          [ -n "$BODY" ] && BODY=" ¬∑ $BODY"

          MSG="üöÄ **[Release $TAG: $REL_NAME](<$URL>)**"$'\n'"$BODY"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  create:
    if: github.event_name == 'create'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REF_TYPE: ${{ github.event.ref_type }}
          REF: ${{ github.event.ref }}
          ACTOR: ${{ github.actor }}
          REPO_URL: ${{ github.event.repository.html_url }}
        run: |
          [ "$REF_TYPE" = "branch" ] && ICON="üåø" || ICON="üè∑Ô∏è"
          MSG="$ICON **${REF_TYPE^} created: [$REF](<$REPO_URL/tree/$REF>)** by @$ACTOR"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-

  delete:
    if: github.event_name == 'delete'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REF_TYPE: ${{ github.event.ref_type }}
          REF: ${{ github.event.ref }}
          ACTOR: ${{ github.actor }}
        run: |
          MSG="üóëÔ∏è **${REF_TYPE^} deleted: $REF** by @$ACTOR"
          jq -n --arg content "$MSG" '{content: $content}' | curl -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
